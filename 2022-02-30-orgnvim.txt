                     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                             FEBRUARY 2022
                      An orgmode clone for neovim

                            Kristijan Husak
                     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”


                               2022-02-30


Timothy (TEC) here. This month we have a guest post from a different
part of the Org ecosystem, to highlight one of the most promising
efforts to provide a good experience outside Emacs.

//github.com/nvim-orgmode/orgmode

â€œBut I use Emacs, I donâ€™t careâ€ you may say. In that case, Iâ€™d like to
point out that wider spread and better Org support enriches the Org
ecosystem as a whole.  It makes the format more approachable, and
/useful/ for other people. This is good for everybody.

Without any further ado, hereâ€™s the guest post kindly written by
Kristijan.  Enjoy!

â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•

Like every beginner Vim user, at some point I ran into a usual editor
war post: Vim vs Emacs. At that time, I didnâ€™t have an idea what â€œEmacsâ€
was.

A simple Google search yielded something that seemed just like a very
simple editor with strange, but more familiar shortcuts. I didnâ€™t bother
too much to figure out what it is, because I was already pulled in
fairly deep into Vim and its philosophy.


Note taking in (Neo)Vim
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  At first, I did some note taking only when really necessary, in random
  plain text files. Most of the things I managed to keep in my head,
  since I was younger and less busy ğŸ™‚.

  Once I got into the situation where I needed to keep more notes,
  [vimwiki] was the natural choice.

  That worked very well for a period, until the need for writing quick
  notes arise. Vimwiki didnâ€™t have anything that would allow that. I
  could of course have a mapping that opens a specific file where I can
  add notes, but that just never felt right in my mind. I would keep a
  bunch of things in the same place, and then later I needed to spend
  some time organizing them.

  At that point, I wasnâ€™t sure how to achieve what I want. I did a brief
  look at [Emacs OrgMode] to see whatâ€™s all the fuss about, but to me,
  it seemed just like a different version of Markdown. You put some
  unordered lists as your notes, and thatâ€™s it. I never spent more time
  trying to see all the neat features. I even tried creating some of my
  custom note taking tools, but I never managed to finish them because I
  didnâ€™t have a clear idea of how to solve my problems.


[vimwiki] <https://github.com/vimwiki/vimwiki>

[Emacs OrgMode] <https://orgmode.org/>


First encounter with Orgmode like tool: vim-dotoo
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  One weekend, I was browsing through Vim subreddit, as I usually do at
  least once a day. There was a post about an â€œOrgmode like task
  loggingâ€ plugin called [vim-dotoo]. I opened it up, and I didnâ€™t see
  much at that point. I wasnâ€™t too excited. I went through readme, and
  noticed that author ([dhruvasagar]) put a fairly big emphasis on the
  â€œAgenda viewâ€. I had no idea what â€œAgenda viewâ€ is.  Thankfully, the
  author also made a [screencast], which is rather long (1.5h), but I
  had some time, so I went through it.

  At that point, I was first met with â€œCapturingâ€ and â€œRefilingâ€. *My
  mind was blown!* What a simple, yet extremely powerful idea! How had
  that never crossed my mind? From that point on, this plugin had my
  full attention.

  Iâ€™m always emphasizing that [dhruvasagar] and his [vim-dotoo] plugin
  are most deserving for having inspired
  <https://github.com/nvim-orgmode/orgmode>, and I canâ€™t thank him
  enough for that.


[vim-dotoo] <https://github.com/dhruvasagar/vim-dotoo>

[dhruvasagar] <https://github.com/dhruvasagar>

[screencast] <https://www.youtube.com/watch?v=nsv33iOnH34>


First steps with vim-dotoo and birth of orgmode.nvim
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  For some time, I was using [vim-dotoo]. I moved all of my Vimwiki
  notes to it. It was a breath of fresh air. Alongside that, I started
  getting more interest in the original Emacs Orgmode. I started
  noticing the differences, and some of the missing features that were
  now looking quite attractive. I made [few contributions] to
  vim-dotoo. As time passed, and my notes started to grow, things began
  being slow. I did some profiling, and figured out that itâ€™s just a
  usual Vim problem, Vimscript performance. It was just too slow for
  certain things that Orgmode provides, and it would hardly get any
  better as more things are added.

  Separately from Vim and Vimscript, [Neovim] was on a stable `v0.4'
  release, and `v0.5' was still being developed. I was using Neovim from
  version 0.3, and was carefully following the progress on it. Lua was
  introduced as a first class citizen. A Bunch of new plugins arise from
  it. All the benchmarks showed that Lua outperforms Vimscript in almost
  everything. Besides the performance, Lua is a â€œnormalâ€ programming
  language, which means that support for it is much better.

  At that point, I became curious: Could Lua be the path to the faster
  Orgmode? I spent several days thinking about it. I wanted to give it a
  try. My biggest concern was that I had absolutely zero experience
  writing parsers. I had never written anything more complicated than an
  averagely complicated regex for purposes of parsing. I noticed that
  vim-dotoo also used regex to do the parsing, so that eased my mind a
  bit.

  One weekend, I started working on it. It was really interesting and
  challenging.  I spent a lot of my free time on it. At certain points,
  it seemed like hacking, since it was not a proper parsing. I tried to
  learn how to write a proper parser, but it was just too time consuming
  and complicated. I proceeded with the regex parsing to see how far I
  can go.

  Besides parsing, I had a few more challenges to overcome:


[vim-dotoo] <https://github.com/dhruvasagar/vim-dotoo>

[few contributions]
<https://github.com/dhruvasagar/vim-dotoo/pulls?q=is%3Apr+sort%3Aupdated-desc+author%3Akristijanhusak+is%3Aclosed>

[Neovim] <https://github.com/neovim/neovim>

Understanding the OrgMode syntax and all the functionality
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  This is still the biggest challenge. I didnâ€™t have any idea how big
  and robust OrgMode is. If I would know it at that time, I wouldnâ€™t
  even jump on this train.  Itâ€™s really hard to grasp all of
  it. Considering Iâ€™ve only used it for around 8 months, I think I made
  some good progress on learning it.


Remote editing
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  By remote editing, I mean automatically updating content in the
  current or any other file. Few examples: adding/updating properties,
  managing tags, changing TODO states, archiving, refiling, remote
  editing from agenda view, etc.

  There is no built-in way to update content in another file through the
  Neovim API, without actually opening the file in an editor. I solved
  this by:

  â€¢ Saving as much position information as possible in the internal
    state, so I can pinpoint the correct location
  â€¢ Opening a file in a `1 row x 1 col' floating window and doing quick
    edits there


Working with dates
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  From my experience, dates are challenging in all areas of programming,
  so this is not so surprising. There are some Lua plugins for dates,
  but those seemed a bit too basic for my use case, and I wanted to keep
  external plugins to the minimum. I went with a custom solution that
  uses Luaâ€™s native dates, which has certain limitations, but works out
  for most of the things.


Highlighting, mostly in Agenda view
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Vimâ€™s syntax engine is fairly old, but still very much used,
  especially in the Vim community. Implementation of tree-sitter
  slightly improved this experience in Neovim, because â€œHighlight
  matchesâ€ are found via tree-sitter, instead of a bunch of regexes.

  This helped me out later for the Org file itself, but agenda view is
  still something thatâ€™s built as a custom view. Old Syntax highlight
  engine would be really hard to add, because the content is too
  dynamic. I went with the Neovim highlight API that allows Highlighting
  things by their exact position in the buffer. Tree-sitter
  implementation does something similar in the background for
  Highlighting.


Keeping configuration simple and familiar to Emacs OrgMode
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  Vim-dotoo configuration was mostly Vim style, through some global
  variables. I wanted to have a configuration that is familiar to an
  Emacs OrgMode user, by having as many options as possible named
  completely the same as in Emacs.

  For example, Hereâ€™s a comparison of few options between Emacs and
  Neovim:

  Emacs:

  â”Œâ”€â”€â”€â”€
  â”‚ (setq org-agenda-files '("~/orgmodes"))
  â”‚ (setq org-agenda-skip-scheduled-if-done t)
  â”‚ (setq org-agenda-span 7)
  â”‚ (setq org-hide-leading-stars t)
  â”‚  (setq org-capture-templates
  â”‚        '(("t" "Todo" entry (file "~/orgmodes/todos.org")
  â”‚       "* TODO %?")
  â”‚      ("j" "Journal" entry (file "~/orgmodes/journal.org")
  â”‚       "* %?\nEntered on %U\n   %a")))
  â””â”€â”€â”€â”€

  Neovim:

  â”Œâ”€â”€â”€â”€
  â”‚ require('orgmode').setup({
  â”‚    org_agenda_files = { '~/orgmodes' },
  â”‚    org_agenda_skip_scheduled_if_done = true,
  â”‚    org_agenda_span = 7,
  â”‚    org_hide_leading_stars = true
  â”‚    org_capture_templates = {
  â”‚       t = {
  â”‚      description = 'Todo',
  â”‚      target = '~/orgmodes/todos.org',
  â”‚      template = '* TODO %?',
  â”‚       },
  â”‚       j = {
  â”‚      description = 'Journal',
  â”‚      target = '~/orgmodes/journal.org',
  â”‚      template = '* %?\nEntered on %U\n   %a',
  â”‚       }
  â”‚    }
  â”‚ })
  â””â”€â”€â”€â”€

  One of the most noticeable differences is between the usage of hyphens
  (`-') and underscores (`_'). I did that only for the sake of
  simplicity, because hyphens is not a valid character in variable names
  in Lua, so all of the options would need to be wrapped as a string
  (for example: `['org-agenda-files']').


First release of orgmode.nvim and introduction of tree-sitter parser
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  After ~1.5 months I [published the initial version]. The focus was on
  Agenda and capturing (GTD), since those are the things I mostly
  used. It got some traction, and people started testing it and
  reporting bugs.

  One of the common questions was: /â€œAny plans to introduce tree-sitter
  parser?â€/.

  I knew about [tree-sitter] and used it in my day-to-day job for a few
  programming languages, but I had absolutely no idea how it worked, and
  especially how to write a tree-sitter parser. I put it aside, and
  continued working on what I had.

  One day, Emilia ([milisims]) contacted me via email to ask me if I
  would be willing to try the tree-sitter parser sheâ€™s been working on
  for some time. I gladly accepted. She gave me access to the
  repository, and I started tinkering with it in a separate branch. No
  one was aware at that point that tree-sitter support would happen some
  time soon.

  After some time, I set up a â€œbetaâ€ branch called â€œtree-sitterâ€ and
  [announced it for testing]. Once the reported bugs slowed to a
  trickle, I merged it into the â€œmasterâ€ branch.

  I believe that tree-sitter grammar for Org could help out other
  editors to implement their version of Orgmode plugin, but I donâ€™t
  think it would ever be helpful for Emacs. Emacs parser is the one and
  only that has it all implemented.  Also, as much as tree-sitter is
  powerful, its main purpose is to parse programming languages, which
  mostly has â€œstaticâ€ patterns to match. Orgmode is by its nature
  dynamic, which causes a variety of issues for a parser thatâ€™s not
  meant for that kind of usage.


[published the initial version]
<https://www.reddit.com/r/neovim/comments/o8zp0k/orgmodenvim_orgmode_clone_written_in_lua_for/>

[tree-sitter] <https://github.com/tree-sitter/tree-sitter>

[milisims] <https://github.com/milisims>

[announced it for testing]
<https://www.reddit.com/r/neovim/comments/ph2xqc/orgmodenvim_treesitter_support/>


Limitations
â•â•â•â•â•â•â•â•â•â•â•

  (Neo)Vim is a great editor, but it still cannot compare to Emacs in
  certain things. Manipulating the â€œViewâ€ part of the editor is tricky
  or impossible for certain things.

  I even [made a label] for reported issues where Neovim support for
  certain things is a blocker. Iâ€™m hoping that at least some of these
  will be available in future Neovim releases.


[made a label]
<https://github.com/nvim-orgmode/orgmode/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Aneovim-dependency>


Features
â•â•â•â•â•â•â•â•

  I will not go into too many details about the available features,
  since those can be viewed in [repository readme], but I want to
  mention one feature that does not exist as a built/-in feature in the
  Emacs Orgmode: [Notifications].

  This allows getting a â€œdesktop notificationâ€ for tasks that are within
  the specified threshold for schedule/deadline time. It requires some
  configuration to set up a cron job, but itâ€™s been working great for me
  for several months now.


[repository readme]
<https://github.com/nvim-orgmode/orgmode#features-detailed-breakdown>

[Notifications]
<https://github.com/nvim-orgmode/orgmode/blob/master/DOCS.md#notifications-experimental>


Plans
â•â•â•â•â•

  The current state of the project is very usable for me. Iâ€™m not
  lacking any of the major features, mostly because Iâ€™m not used to
  using them. Nevertheless, there are plans to add more things, and Iâ€™m
  getting a lot of help from the community. I want to specifically
  mention [levouh] and [lukas-reineke], since they added a lot of value
  to the project, and I want to thank them and everyone else who
  contributed. Their help is much appreciated.

  There are few high priority tasks that Iâ€™m hoping to flush out first:

  â€¢ Implementing [v1.0.0] release of the tree-sitter parser. This should
    allow for faster and less error-prone parsing.
  â€¢ [Infrastructure for plugin developers], to allow other people to
    build plugins on top of nvim-orgmode.

  And a long term goal for these:

  â€¢ Tables support (and at least basic formulas)
  â€¢ [Org Babel like code block evaluation] (and hopefully basic support
    for literate programming)
  â€¢ [Diary format dates]
  â€¢ [Custom agenda commands]
  â€¢ More clocking features (reports)
  â€¢ File specific configuration via directives ([todo keywords],
    properties, etc.)


[levouh] <https://github.com/levouh>

[lukas-reineke] <https://github.com/lukas-reineke>

[v1.0.0] <https://github.com/milisims/tree-sitter-org/issues/13>

[Infrastructure for plugin developers]
<https://github.com/nvim-orgmode/orgmode/issues/26>

[Org Babel like code block evaluation]
<https://github.com/nvim-orgmode/orgmode/issues/190>

[Diary format dates]
<https://github.com/nvim-orgmode/orgmode/issues/195>

[Custom agenda commands]
<https://github.com/nvim-orgmode/orgmode/issues/135>

[todo keywords] <https://github.com/nvim-orgmode/orgmode/issues/185>


Closing thoughts
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  When I started working on [nvim-orgmode], I didnâ€™t have a clue what
  Iâ€™m jumping into. Every day I learn about more and more Orgmode
  features that I wasnâ€™t even aware existed.

  Iâ€™m certain that this project will never manage to clone the Orgmode
  functionality completely, but Iâ€™m hoping it will get close enough so
  everyone from Neovim community and Emacsers trying out Neovim will be
  able to use it for their needs.

  Having experienced Orgmode users [testing] it is a huge help, so if
  anyone is willing to give it a try, feel free to open up an issue and
  write your thoughts there. Thanks!


[nvim-orgmode] <https://github.com/nvim-orgmode/orgmode>

[testing] <https://github.com/nvim-orgmode/orgmode/issues/159>
